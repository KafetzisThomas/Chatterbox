{% extends "rt_chat/base.html" %}

{% block page_header %}
    <div class="text-center">
        <h1 class="display-4">Welcome, {{ request.user|title }}!</h1>
        <form action="{% url 'users:logout' %}" method="post" class="mt-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
{% endblock page_header %}

{% block content %}
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Chat Room</h5>
        </div>
        <div class="card-body">
            <div id="chat_messages" class="overflow-auto bg-light rounded p-3 mb-3" style="height: 300px;">
                <!-- Chat messages will appear here -->
            </div>
            <div class="d-flex">
                <input type="text" class="form-control me-2" id="message_send_input" placeholder="Type your message..." autofocus />
                <button type="submit" class="btn btn-success" id="message_send_button">Send</button>
            </div>
        </div>
    </div>

    <script>
        const chatSocket = new WebSocket("ws://" + window.location.host + "/");

        chatSocket.onopen = function (e) {
            console.log("The connection was set up successfully!");
        };

        chatSocket.onclose = function (e) {
            console.log("Something unexpected happened!");
        };

        document.querySelector("#message_send_input").focus();

        document.querySelector("#message_send_input").onkeyup = function (e) {
            if (e.keyCode === 13) {
                document.querySelector("#message_send_button").click();
            }
        };

        document.querySelector("#message_send_button").onclick = function (e) {
            const messageInput = document.querySelector("#message_send_input").value.trim();
            if (messageInput) {
                chatSocket.send(JSON.stringify({ message: messageInput, username: "{{ request.user.username }}" }));
            }
            document.querySelector("#message_send_input").value = "";
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const div = document.createElement("div");
            div.classList.add("alert", "alert-secondary", "p-2", "mb-1");
            div.textContent = `${data.username}: ${data.message}`;
            document.querySelector("#chat_messages").appendChild(div);
            document.querySelector("#chat_messages").scrollTop = document.querySelector("#chat_messages").scrollHeight;
        };
    </script>
{% endblock content %}
